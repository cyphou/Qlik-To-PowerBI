name: Deploy Fabric Artifacts

on:
  push:
    branches: [ main, staging ]
    paths:
      - 'artifacts/**'
      - 'src/**'
      - 'requirements.txt'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: '3.11'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Lint code
        run: |
          pip install pylint
          pylint src/fabric_api/ --disable=all --enable=E,F
      
      - name: Validate artifacts
        run: |
          python -c "
          from fabric_api.validator import ArtifactValidator
          from pathlib import Path
          results = ArtifactValidator.validate_directory(Path('artifacts'))
          invalid = [f for f, (v, _) in results.items() if not v]
          if invalid:
            print(f'Invalid artifacts: {invalid}')
            exit(1)
          print('âœ“ All artifacts valid')
          "

  test:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests
        run: pytest tests/ --cov=src/fabric_api --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml

  deploy:
    runs-on: ubuntu-latest
    needs: [ validate, test ]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Deploy artifacts
        env:
          FABRIC_WORKSPACE_ID: ${{ secrets.FABRIC_WORKSPACE_ID }}
          FABRIC_TENANT_ID: ${{ secrets.FABRIC_TENANT_ID }}
          FABRIC_CLIENT_ID: ${{ secrets.FABRIC_CLIENT_ID }}
          FABRIC_CLIENT_SECRET: ${{ secrets.FABRIC_CLIENT_SECRET }}
          LOG_LEVEL: INFO
        run: |
          python src/main.py
      
      - name: Archive deployment report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: deployment-report
          path: fabric-deployment.log
